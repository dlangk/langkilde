---
import { ANALYTICS } from "../lib/constants";
---

<script is:inline define:vars={{ gaId: ANALYTICS.gaId }}>
  // Defer analytics loading until after page is interactive
  function loadAnalytics() {
    const script = document.createElement("script");
    script.src = `https://www.googletagmanager.com/gtag/js?id=${gaId}`;
    script.async = true;
    document.head.appendChild(script);

    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    window.gtag = gtag;

    const rawPath = window.location.pathname;
    const normalizedPath = rawPath.replace(/\/+$/, "") || "/";

    gtag("js", new Date());
    gtag("config", gaId, {
      page_path: normalizedPath,
    });
  }

  // Load after page is idle, or after 2 seconds max
  if ("requestIdleCallback" in window) {
    requestIdleCallback(loadAnalytics, { timeout: 2000 });
  } else {
    setTimeout(loadAnalytics, 100);
  }
</script>
